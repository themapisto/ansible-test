---
# This playbook will install MariaDB and create db user and give permissions.

- name: example copying file with owner and permissions
  unarchive:
    src: "{{ __src_tarfile }}"
    dest: /usr/local
    copy: yes
    owner: root
    group: root
    mode: 0644


# tar Extract archive
# group, user add
# group, owner change
# Mysql Configuration file make
### mariadb install


- name: Simbolic link
  file:
    src: "{{ __mariadb_src }}"
    path: "{{ __mariadb_home }}"
    state: link
  become: yes

- name: groupadd
  command: groupadd mysql

- name: useradd
  command: useradd -g mysql mysql

- name: mysql folder owner change
  command: chdir={{ __mariadb_home }} chown -R mysql .

- name: mysql folder group change
  command: chdir={{ __mariadb_home }} chgrp -R mysql .

- name: Create Mysql configuration file
  template: src=my.cnf.j2 dest=/etc/my.cnf
  notify:
  - restart mariadb
## ncurse / libaio-dev
## 템플릿 UBU


## permission denied



- name: Configure SELinux to start mysql on any port
  seboolean: name=mysql_connect_any state=true persistent=yes

- name: Create MariaDB log file
  file: path=/var/log/mysqld.log state=touch owner=mysql group=mysql mode=0775

- name: make Directory
  command: chdir=/var/lib mkdir mysql

- name: chown Directoryexit
  command: chdir=/var/lib chown mysql mysql

- name: chgrp Directory
  command: chdir=/var/lib chgrp mysql mysql



- name: Create Mariadb pid file
  file: path=/var/log/mysqld.pid state=touch owner=mysql group=mysql mode=0775

- name: Permission mysql_install script
  command: chdir={{ __mariadb_home }}/scripts/ chmod 755 mysql_install_db

- name: Permission ./bin/my_print_defaults
  command: chdir={{ __mariadb_home }}/bin/ chmod 755 my_print_defaults

- name: mysql_install
  command: chdir={{ __mariadb_home }} ./scripts/mysql_install_db --user=mysql --defaults-file=/etc/my.cnf

- name: Delete ibdata.*
  command: chdir=/var/lib/mysql/ rm -rf ib*

- name: Start mysqld_safe
  command: chdir="{{ __mariadb_home }}" ./mysqld_safe --user=mysql &

- name: insert firewalld rule
  firewalld: port={{ mysql_port }}/tcp permanent=true state=enabled immediate=yes
  ignore_errors: yes